stages:
  - prepare
  - build
  - package
  - deploy

variables:
  BUILD_CONTAINER: $CI_REGISTRY_IMAGE/chromium-build-image:$CI_COMMIT_REF_NAME
  GIT_SUBMODULE_STRATEGY: recursive

.ppc-build-base:
  image: $BUILD_CONTAINER
  timeout: 6h

  only:
    - tags
    - web

  tags:
    - ppc64le
    - docker

container:
  extends: .ppc-build-base
  image: fedora:latest
  stage: prepare

  variables:
    _BUILDAH_STARTED_IN_USERNS: ""
    BUILDAH_FORMAT: docker
    BUILDAH_ISOLATION: chroot
    GIT_SUBMODULE_STRATEGY: none

  script:
    - dnf install
        --setopt=install_weak_deps=False
        --disablerepo="*modular*"
        -y buildah
    - sed -e 's/^driver =.*/driver = "vfs"/'
          -e '/^mountopt =.*/d'
          -i /etc/containers/storage.conf
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - buildah bud -t $BUILD_CONTAINER .
    - buildah push $BUILD_CONTAINER

build:
  extends: .ppc-build-base
  stage: build

  script:
    - make -C docker-root -j16
    # TODO: Once https://gitlab.com/gitlab-org/gitlab/issues/22638 is fixed,
    # just pass the variable
    - echo "export ARTIFACTS_URL=$CI_JOB_URL/artifacts/raw/target" > artifacts_url.sh

  artifacts:
    paths:
      - docker-root/target/*.tar*
      - docker-root/target/*.rpm
      - docker-root/ccache*xz
      - artifacts_url.sh

  cache:
    key: chromium-build-cache
    paths:
      - docker-root/.ccache

create-repo:
  extends: .ppc-build-base
  stage: package
  dependencies:
    - build

  variables:
    GIT_STRATEGY: none

  script:
    - mkdir -p repo/{chromium,chromium-testing}
    - . artifacts_url.sh
    - createrepo -v -u $ARTIFACTS_URL -o repo/chromium docker-root/target
    - createrepo -v -u $ARTIFACTS_URL -o repo/chromium-testing docker-root/target

  artifacts:
    paths:
      - repo/

.repo-deploy-base: &repo-deploy-base
  stage: deploy

  variables:
    UPSTREAM_BRANCH: $CI_COMMIT_REF_NAME
    UPSTREAM_PROJECT_ID: $CI_PROJECT_ID

  only:
    - tags
    - web

# TODO: after https://gitlab.com/gitlab-org/gitlab/issues/10876 is resolved, use
# `trigger:` in both cases
repo-deploy:
  extends: .ppc-build-base
  stage: deploy

  dependencies:
    - create-repo

  variables:
    GIT_STRATEGY: none

  script:
    - curl -s --request POST
           --form token=$CI_JOB_TOKEN
           --form ref=master
           --form "variables[UPSTREAM_BRANCH]=$CI_COMMIT_REF_NAME"
           --form "variables[UPSTREAM_PROJECT_ID]=$CI_PROJECT_ID"
           $CI_API_V4_URL/projects/15569783/trigger/pipeline

testing-repo-deploy:
  <<: *repo-deploy-base
  trigger:
    project: chromium-ppc64le/dnf/chromium-testing
    strategy: depend

