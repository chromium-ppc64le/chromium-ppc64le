stages:
  - build
  - package
  - deploy

build:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive

  only:
    - tags
    - web

  tags:
    - ppc64le

  stage: build

  timeout: 6h

  script:
    - dnf install -y findutils createrepo_c
    - make gitlab-build
    - mkdir -p repo
    - createrepo -v -u ${CI_JOB_URL}/artifacts/raw/target -o repo target

  artifacts:
    paths:
      - repo/
      - target/*.tar*
      - target/*.rpm

package:
  stage: package

  dependencies:
    - build

  only:
    - tags
    - web

  tags:
    - ppc64le

  script:
    - mkdir -p repo
    - createrepo -v -u ${CI_JOB_URL}/artifacts/raw/target -o repo target

  artifacts:
    paths:
      - repo/

pages:
  stage: deploy
  dependencies:
    - package

  only:
    - tags
    - web

  when: manual

  tags:
    - ppc64le

  script:
    - rm -rf public
    - mkdir public
    - mv repo/ public/dnf-repo

  artifacts:
    paths:
      - public

